<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>GPS —Ç—Ä–µ–∫–µ—Ä</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
html, body { margin:0; padding:0; height:100%; }
#map { height:100vh; width:100vw; }

/* –ü–∞–Ω–µ–ª—å –∫–Ω–æ–ø–æ–∫ */
#controls {
  position:absolute;
  top:10px;
  left:50%;
  transform:translateX(-50%);
  z-index:1000;
  background:#fff;
  padding:8px;
  border-radius:12px;
  display:flex;
  gap:6px;
  box-shadow:0 2px 8px rgba(0,0,0,.25);
}

button {
  padding:8px 12px;
  border-radius:8px;
  border:1px solid #ccc;
  background:#f5f5f5;
  font-size:14px;
}
button.active {
  background:#0077ff;
  color:#fff;
  border-color:#0077ff;
}

/* –ö–Ω–æ–ø–∫–∞ —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è */
#centerBtn {
  position:absolute;
  right:15px;
  top:50%;
  transform:translateY(-50%);
  z-index:1000;
  width:48px;
  height:48px;
  border-radius:50%;
  background:#fff;
  border:1px solid #ccc;
  box-shadow:0 2px 6px rgba(0,0,0,.3);
}

/* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–ø–∏—Å–∏ */
#rec {
  position:absolute;
  bottom:120px;
  left:50%;
  transform:translateX(-50%);
  z-index:1000;
  display:flex;
  align-items:center;
  gap:8px;
  font-size:14px;
}
#dot {
  width:12px;
  height:12px;
  background:red;
  border-radius:50%;
  opacity:0;
}
.blink {
  animation: blink 1s infinite;
}
@keyframes blink {
  0% { opacity:1 }
  50% { opacity:0 }
  100% { opacity:1 }
}

/* –ò–Ω—Ñ–æ */
#info {
  position:absolute;
  bottom:10px;
  left:50%;
  transform:translateX(-50%);
  z-index:1000;
  background:rgba(255,255,255,.95);
  padding:10px 14px;
  border-radius:10px;
  font-size:14px;
  box-shadow:0 2px 6px rgba(0,0,0,.3);
  text-align:center;
}

/* –¢—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫ */
.arrow {
  width:0;
  height:0;
  border-left:10px solid transparent;
  border-right:10px solid transparent;
  border-bottom:20px solid blue;
}
</style>
</head>

<body>

<div id="controls">
  <button id="startBtn">‚ñ∂ –°—Ç–∞—Ä—Ç GPS</button>
  <button id="stopBtn">‚èπ –°—Ç–æ–ø GPS</button>
  <button id="saveBtn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
</div>

<button id="centerBtn">üéØ</button>

<div id="rec">
  <div id="dot"></div>
  <div>–ó–∞–ø–∏—Å—å</div>
</div>

<div id="info">
  ‚è± <span id="time">0:00</span><br>
  üìè <span id="dist">0.00</span> –∫–º
</div>

<div id="map"></div>

<script>
// ================== –ö–ê–†–¢–ê ==================
const map = L.map('map').setView([0,0], 2);
L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

// ================== –ü–ï–†–ï–ú–ï–ù–ù–´–ï ==================
let userMarker = null;
let watchId = null;
let follow = true;
let trackTimer = null;
let lastPos = null;
let lastTime = null;

let track = [];
let distance = 0;
let startTime = null;

// ================== –ò–ö–û–ù–ö–ê –¢–†–ï–£–ì–û–õ–¨–ù–ò–ö–ê ==================
function arrowIcon(angle) {
  return L.divIcon({
    className:'',
    html:`<div class="arrow" style="transform:rotate(${angle}deg)"></div>`,
    iconSize:[20,20],
    iconAnchor:[10,10]
  });
}

// ================== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï ==================
function haversine(a,b){
  const R=6371000;
  const dLat=(b[0]-a[0])*Math.PI/180;
  const dLon=(b[1]-a[1])*Math.PI/180;
  const lat1=a[0]*Math.PI/180;
  const lat2=b[0]*Math.PI/180;
  const h=Math.sin(dLat/2)**2+Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2;
  return 2*R*Math.asin(Math.sqrt(h));
}

// ================== –û–ë–ù–û–í–õ–ï–ù–ò–ï GPS ==================
function update(pos){
  const lat = pos.coords.latitude;
  const lon = pos.coords.longitude;
  const speed = pos.coords.speed || 0;

  if(!userMarker){
    userMarker = L.marker([lat,lon]).addTo(map);
  } else {
    userMarker.setLatLng([lat,lon]);
  }

  if(follow) map.setView([lat,lon], map.getZoom());

  if(lastPos){
    const angle = Math.atan2(lon-lastPos[1], lat-lastPos[0])*180/Math.PI;
    userMarker.setIcon(arrowIcon(angle));
  }

  window.currentFix = {lat,lon,speed,time:Date.now()};
}

// ================== –ó–ê–ü–ò–°–¨ –¢–†–ï–ö–ê ==================
function record(){
  if(!window.currentFix) return;
  const {lat,lon,speed,time} = window.currentFix;

  if(speed < 0.5) return;

  if(lastPos){
    const d = haversine(lastPos,[lat,lon]);
    if(d < 5) return;
    distance += d;
  }

  track.push({lat,lon,time,speed,dist:distance});
  lastPos = [lat,lon];

  L.circleMarker([lat,lon],{radius:3,color:'red'}).addTo(map);
  document.getElementById('dist').textContent = (distance/1000).toFixed(2);
}

// ================== –ö–ù–û–ü–ö–ò ==================
const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');
const saveBtn = document.getElementById('saveBtn');
const centerBtn = document.getElementById('centerBtn');
const dot = document.getElementById('dot');

startBtn.onclick = () => {
  startBtn.classList.add('active');
  stopBtn.classList.remove('active');
  dot.classList.add('blink');
  follow = true;

  startTime = Date.now();
  watchId = navigator.geolocation.watchPosition(update,null,{enableHighAccuracy:true});
  trackTimer = setInterval(record,3000);

  map.setZoom(18);
};

stopBtn.onclick = () => {
  stopBtn.classList.add('active');
  startBtn.classList.remove('active');
  dot.classList.remove('blink');

  follow = false;
  navigator.geolocation.clearWatch(watchId);
  clearInterval(trackTimer);
};

centerBtn.onclick = () => {
  if(userMarker){
    follow = true;
    map.setView(userMarker.getLatLng(),18);
  }
};

map.on('dragstart zoomstart',()=>follow=false);

// ================== –¢–ê–ô–ú–ï–† ==================
setInterval(()=>{
  if(startTime){
    const sec = Math.floor((Date.now()-startTime)/1000);
    document.getElementById('time').textContent =
      Math.floor(sec/60)+':'+String(sec%60).padStart(2,'0');
  }
},1000);

// ================== –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ CSV ==================
saveBtn.onclick = () => {
  if(!track.length) return alert('–¢—Ä–µ–∫ –ø—É—Å—Ç');
  let csv = 'lat,lon,time,speed,distance_m\n';
  track.forEach(p=>{
    csv+=`${p.lat},${p.lon},${p.time},${p.speed},${p.dist.toFixed(2)}\n`;
  });
  const blob = new Blob([csv],{type:'text/csv'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'track.csv';
  a.click();
};
</script>
</body>
</html>
