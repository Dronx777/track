<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<title>GPS Track Recorder</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet/dist/leaflet.css"
/>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
html, body, #map {
  height: 100%;
  margin: 0;
}

.controls {
  position: fixed;
  right: 12px;
  top: 50%;
  transform: translateY(-50%);
  display: flex;
  flex-direction: column;
  gap: 8px;
  z-index: 1000;
}

button {
  padding: 10px 12px;
  font-size: 14px;
  border-radius: 8px;
  border: none;
  background: #eee;
}

button.active {
  background: #2196f3;
  color: white;
}

#status {
  position: fixed;
  bottom: 12px;
  left: 12px;
  background: rgba(0,0,0,0.7);
  color: white;
  padding: 10px;
  border-radius: 8px;
  font-size: 13px;
}

#dot {
  display: inline-block;
  width: 10px;
  height: 10px;
  background: red;
  border-radius: 50%;
  margin-right: 6px;
  opacity: 0;
}

.blink {
  animation: blink 1s infinite;
}

@keyframes blink {
  0% { opacity: 1 }
  50% { opacity: 0 }
  100% { opacity: 1 }
}
</style>
</head>

<body>

<div id="map"></div>

<div class="controls">
  <button id="start">‚ñ∂ START GPS</button>
  <button id="stop">‚èπ STOP GPS</button>
  <button id="save">üíæ SAVE CSV</button>
  <button id="center">üìç CENTER</button>
</div>

<div id="status">
  <span id="dot"></span>
  ‚è± <span id="time">0:00</span><br>
  üìè <span id="distance">0</span> m
</div>

<script>
const map = L.map('map').setView([0,0], 2);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 20
}).addTo(map);

let watchId = null;
let trackTimer = null;
let timerInterval = null;

let startTime = 0;
let elapsedTime = 0;
let totalDistance = 0;

let lastPoint = null;
let track = [];

let follow = true;
let firstFix = true;

let userMarker = null;
let trackLayer = L.layerGroup().addTo(map);

const startBtn = document.getElementById("start");
const stopBtn = document.getElementById("stop");
const saveBtn = document.getElementById("save");
const centerBtn = document.getElementById("center");
const timeEl = document.getElementById("time");
const distEl = document.getElementById("distance");
const dot = document.getElementById("dot");

map.on("dragstart zoomstart", () => follow = false);

function haversine(a, b) {
  const R = 6371000;
  const dLat = (b.lat - a.lat) * Math.PI / 180;
  const dLon = (b.lon - a.lon) * Math.PI / 180;
  const la1 = a.lat * Math.PI / 180;
  const la2 = b.lat * Math.PI / 180;

  return 2 * R * Math.asin(Math.sqrt(
    Math.sin(dLat/2)**2 +
    Math.cos(la1)*Math.cos(la2)*Math.sin(dLon/2)**2
  ));
}

function update(pos) {
  const lat = pos.coords.latitude;
  const lon = pos.coords.longitude;
  const speed = pos.coords.speed || 0;
  const heading = pos.coords.heading || 0;

  if (!userMarker) {
    userMarker = L.marker([lat, lon], {
      icon: L.divIcon({
        className: '',
        html: '‚ñ≤',
        iconSize: [20,20]
      })
    }).addTo(map);

    map.setView([lat, lon], 18);
  } else {
    userMarker.setLatLng([lat, lon]);
    userMarker.getElement().style.transform =
      `rotate(${heading}deg)`;
  }

  if (follow) map.panTo([lat, lon]);

  userMarker._speed = speed;
  userMarker._pos = { lat, lon };
}

function record() {
  if (!userMarker) return;

  const speed = userMarker._speed;
  const point = userMarker._pos;

  if (speed < 0.5) return;

  if (lastPoint) {
    const d = haversine(lastPoint, point);
    if (d < 5) return;
    totalDistance += d;
  }

  lastPoint = point;

  track.push({
    lat: point.lat,
    lon: point.lon,
    speed: speed,
    distance: totalDistance
  });

  L.circleMarker([point.lat, point.lon], {
    radius: 3,
    color: "red"
  }).addTo(trackLayer);

  distEl.textContent = totalDistance.toFixed(1);
}

startBtn.onclick = () => {
  startBtn.classList.add("active");
  stopBtn.classList.remove("active");
  dot.classList.add("blink");

  follow = true;

  startTime = Date.now() - elapsedTime;

  if (!timerInterval) {
    timerInterval = setInterval(() => {
      elapsedTime = Date.now() - startTime;
      const sec = Math.floor(elapsedTime / 1000);
      timeEl.textContent =
        Math.floor(sec / 60) + ":" + String(sec % 60).padStart(2,"0");
    }, 1000);
  }

  if (!watchId) {
    watchId = navigator.geolocation.watchPosition(update, null, {
      enableHighAccuracy: true
    });
  }

  if (!trackTimer) {
    trackTimer = setInterval(record, 3000);
  }
};

stopBtn.onclick = () => {
  stopBtn.classList.add("active");
  startBtn.classList.remove("active");
  dot.classList.remove("blink");

  follow = false;

  if (watchId) {
    navigator.geolocation.clearWatch(watchId);
    watchId = null;
  }

  clearInterval(trackTimer);
  trackTimer = null;

  clearInterval(timerInterval);
  timerInterval = null;
};

centerBtn.onclick = () => {
  if (userMarker) {
    follow = true;
    map.setView(userMarker.getLatLng(), 18);
  }
};

saveBtn.onclick = () => {
  let csv = "lat,lon,speed,distance\n";
  track.forEach(p => {
    csv += `${p.lat},${p.lon},${p.speed},${p.distance}\n`;
  });

  const blob = new Blob([csv], { type: "text/csv" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "track.csv";
  a.click();
};
</script>

</body>
</html>
