<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>GPS —Ç—Ä–µ–∫–µ—Ä</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/shpjs@latest/dist/shp.min.js"></script>

<style>
html, body { margin:0; padding:0; height:100%; }
#map { height:100vh; width:100vw; }

#controls {
  position:absolute;
  top:10px;
  left:50%;
  transform:translateX(-50%);
  z-index:1000;
  background:#fff;
  padding:8px;
  border-radius:12px;
  display:flex;
  gap:6px;
  box-shadow:0 2px 8px rgba(0,0,0,.25);
}
button {
  padding:8px 12px;
  border-radius:8px;
  border:1px solid #ccc;
  background:#f5f5f5;
  font-size:14px;
}
button.active {
  background:#0077ff;
  color:#fff;
  border-color:#0077ff;
}

#centerBtn {
  position:absolute;
  right:15px;
  top:50%;
  transform:translateY(-50%);
  z-index:1000;
  width:48px;
  height:48px;
  border-radius:50%;
  background:#fff;
  border:1px solid #ccc;
  box-shadow:0 2px 6px rgba(0,0,0,.3);
}

#rec {
  position:absolute;
  bottom:120px;
  left:50%;
  transform:translateX(-50%);
  z-index:1000;
  display:flex;
  align-items:center;
  gap:8px;
  font-size:14px;
}
#dot {
  width:12px;
  height:12px;
  background:red;
  border-radius:50%;
  opacity:0;
}
.blink { animation: blink 1s infinite; }
@keyframes blink {
  0% {opacity:1} 50% {opacity:0} 100% {opacity:1}
}

#info {
  position:absolute;
  bottom:10px;
  left:50%;
  transform:translateX(-50%);
  z-index:1000;
  background:rgba(255,255,255,.95);
  padding:10px 14px;
  border-radius:10px;
  font-size:14px;
  box-shadow:0 2px 6px rgba(0,0,0,.3);
  text-align:center;
}

.arrow {
  width:0;
  height:0;
  border-left:10px solid transparent;
  border-right:10px solid transparent;
  border-bottom:20px solid green;
}
</style>
</head>

<body>

<div id="controls">
  <button id="startBtn">‚ñ∂ –°—Ç–∞—Ä—Ç GPS</button>
  <button id="stopBtn">‚èπ –°—Ç–æ–ø GPS</button>
  <button id="saveBtn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
</div>

<button id="centerBtn">üéØ</button>

<div id="rec">
  <div id="dot"></div>
  <div>–ó–∞–ø–∏—Å—å</div>
</div>

<div id="info">
  ‚è± <span id="time">0:00</span><br>
  üìè <span id="dist">0.00</span> –∫–º
</div>

<div id="map"></div>

<script>
// ================== –ö–ê–†–¢–ê ==================
const map = L.map('map').setView([0,0],2);
L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

// ================== SHAPEFILE ==================
const shpLayer = L.geoJSON(null, {
  style: {
    color: 'blue',
    weight: 2,
    fillColor: 'blue',
    fillOpacity: 0.2
  }
}).addTo(map);

shp("https://dronx777.github.io/track/shp.zip")
  .then(geojson => {
    shpLayer.addData(geojson);
    if (shpLayer.getBounds().isValid()) {
      map.fitBounds(shpLayer.getBounds());
    }
  })
  .catch(err => console.error("SHP error:", err));

// ================== –ü–ï–†–ï–ú–ï–ù–ù–´–ï ==================
let userMarker = null;
let watchId = null;
let follow = false;
let lastFixPos = null;
let lastTrackPos = null;

let track = [];
let distance = 0;
let startTime = null;
let timerInterval = null;
let recordInterval = null;

// ================== –ò–ö–û–ù–ö–ê ==================
function arrowIcon(angle){
  return L.divIcon({
    className:'',
    html:`<div class="arrow" style="transform:rotate(${angle}deg)"></div>`,
    iconSize:[20,20],
    iconAnchor:[10,10]
  });
}

// ================== –ú–ê–¢–ï–ú–ê–¢–ò–ö–ê ==================
function haversine(a,b){
  const R=6371000;
  const dLat=(b[0]-a[0])*Math.PI/180;
  const dLon=(b[1]-a[1])*Math.PI/180;
  const lat1=a[0]*Math.PI/180;
  const lat2=b[0]*Math.PI/180;
  const h=Math.sin(dLat/2)**2 +
          Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2;
  return 2*R*Math.asin(Math.sqrt(h));
}

// ================== GPS ==================
function onGps(pos){
  const lat = pos.coords.latitude;
  const lon = pos.coords.longitude;
  const speed = pos.coords.speed || 0;

  if(!userMarker){
    userMarker = L.marker([lat,lon]).addTo(map);
    map.setView([lat,lon],18);
  } else {
    userMarker.setLatLng([lat,lon]);
  }

  if(lastFixPos){
    const angle = Math.atan2(
      lon-lastFixPos[1],
      lat-lastFixPos[0]
    ) * 180 / Math.PI;
    userMarker.setIcon(arrowIcon(angle));
  }

  lastFixPos = [lat,lon];
  if(follow) map.panTo([lat,lon]);

  window.currentFix = {lat,lon,speed,time:Date.now()};
}

// ================== –¢–†–ï–ö ==================
function recordTrack(){
  if(!window.currentFix) return;
  const {lat,lon,speed,time} = window.currentFix;
  if(speed < 0.5) return;

  if(lastTrackPos){
    const d = haversine(lastTrackPos,[lat,lon]);
    if(d < 5) return;
    distance += d;
  }

  lastTrackPos = [lat,lon];
  track.push({lat,lon,time,speed,dist:distance});
  L.circleMarker([lat,lon],{radius:3,color:'red'}).addTo(map);
  document.getElementById('dist').textContent = (distance/1000).toFixed(2);
}

// ================== –¢–ê–ô–ú–ï–† ==================
function startTimer(){
  startTime = Date.now();
  timerInterval = setInterval(()=>{
    const sec = Math.floor((Date.now()-startTime)/1000);
    document.getElementById('time').textContent =
      Math.floor(sec/60)+':'+String(sec%60).padStart(2,'0');
  },1000);
}
function stopTimer(){
  clearInterval(timerInterval);
}

// ================== –ö–ù–û–ü–ö–ò ==================
startBtn.onclick = ()=>{
  startBtn.classList.add('active');
  stopBtn.classList.remove('active');
  dot.classList.add('blink');
  follow = true;

  watchId = navigator.geolocation.watchPosition(onGps,null,{enableHighAccuracy:true});
  recordInterval = setInterval(recordTrack,3000);
  startTimer();
};

stopBtn.onclick = ()=>{
  stopBtn.classList.add('active');
  startBtn.classList.remove('active');
  dot.classList.remove('blink');
  follow = false;

  navigator.geolocation.clearWatch(watchId);
  clearInterval(recordInterval);
  stopTimer();
};

centerBtn.onclick = ()=>{
  if(userMarker){
    follow = true;
    map.setView(userMarker.getLatLng(),18);
  }
};
map.on('dragstart zoomstart',()=>follow=false);

// ================== CSV ==================
saveBtn.onclick = ()=>{
  if(!track.length) return alert('–¢—Ä–µ–∫ –ø—É—Å—Ç');
  let csv = 'lat,lon,time,speed_mps,distance_m\n';
  track.forEach(p=>{
    csv += `${p.lat},${p.lon},${p.time},${p.speed},${p.dist.toFixed(2)}\n`;
  });
  const blob = new Blob([csv],{type:'text/csv'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'track.csv';
  a.click();
};
</script>
</body>
</html>
