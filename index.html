<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<title>GPS Tracker</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
html, body {
  margin: 0;
  padding: 0;
  height: 100%;
}
#map {
  width: 100%;
  height: 100%;
}

/* –ü–∞–Ω–µ–ª—å –∫–Ω–æ–ø–æ–∫ */
.controls {
  position: absolute;
  top: 10px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 1000;
  display: flex;
  gap: 8px;
}
.controls button {
  padding: 8px 12px;
  border-radius: 8px;
  border: 1px solid #ccc;
  background: #fff;
  font-size: 14px;
  cursor: pointer;
}

/* –ê–∫—Ç–∏–≤–Ω–∞—è –∫–Ω–æ–ø–∫–∞ */
button.active {
  background: #0077ff;
  color: #fff;
  border-color: #005fd1;
  box-shadow: 0 2px 6px rgba(0, 119, 255, 0.4);
}

/* –ö–Ω–æ–ø–∫–∞ —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è */
.center-btn {
  position: absolute;
  right: 10px;
  top: 50%;
  transform: translateY(-50%);
  z-index: 1000;
  background: #fff;
  border-radius: 50%;
  width: 46px;
  height: 46px;
  font-size: 22px;
  border: 1px solid #ccc;
  cursor: pointer;
}
.center-btn.active {
  background: #0077ff;
  color: #fff;
}
</style>
</head>

<body>

<div class="controls">
  <button id="startBtn" onclick="startGPS()">‚ñ∂ –°—Ç–∞—Ä—Ç GPS</button>
  <button id="stopBtn" onclick="stopGPS()">‚èπ –°—Ç–æ–ø GPS</button>
  <button onclick="saveTrackCSV()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
</div>

<button id="centerBtn" class="center-btn" onclick="enableFollow()">üìç</button>

<div id="map"></div>

<script>
/* ================== –ö–ê–†–¢–ê ================== */
const map = L.map('map').setView([0, 0], 2);
L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

/* ================== –°–û–°–¢–û–Ø–ù–ò–ï ================== */
let followUser = true;
let watchId = null;
let trackTimer = null;

let userMarker = null;
let lastCoords = null;
let lastTrackPoint = null;
let lastSpeed = 0;

let trackPoints = [];
let totalDistance = 0;

const trackLayer = L.layerGroup().addTo(map);

/* ================== –ö–ù–û–ü–ö–ò ================== */
const startBtn = document.getElementById("startBtn");
const stopBtn = document.getElementById("stopBtn");
const centerBtn = document.getElementById("centerBtn");

/* ================== –û–¢–ö–õ–Æ–ß–ï–ù–ò–ï –ê–í–¢–û–°–õ–ï–ñ–ï–ù–ò–Ø ================== */
map.on('dragstart zoomstart', () => {
  followUser = false;
  centerBtn.classList.remove("active");
});

/* ================== –¶–ï–ù–¢–†–ò–†–û–í–ê–ù–ò–ï ================== */
function enableFollow() {
  followUser = true;
  centerBtn.classList.add("active");
  if (lastCoords) map.setView(lastCoords, 17);
}

/* ================== GPS ================== */
function startGPS() {
  if (!navigator.geolocation) {
    alert("GPS –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è");
    return;
  }

  startBtn.classList.add("active");
  stopBtn.classList.remove("active");

  watchId = navigator.geolocation.watchPosition(
    updatePosition,
    err => alert(err.message),
    { enableHighAccuracy: true, maximumAge: 1000, timeout: 10000 }
  );

  trackTimer = setInterval(recordTrackPoint, 3000);
}

function stopGPS() {
  if (watchId) {
    navigator.geolocation.clearWatch(watchId);
    watchId = null;
  }
  clearInterval(trackTimer);
  trackTimer = null;

  startBtn.classList.remove("active");
  stopBtn.classList.add("active");
}

/* ================== –û–ë–ù–û–í–õ–ï–ù–ò–ï –ü–û–ó–ò–¶–ò–ò ================== */
function updatePosition(pos) {
  const { latitude, longitude, speed, heading } = pos.coords;
  lastCoords = [latitude, longitude];
  lastSpeed = speed || 0;

  if (!userMarker) {
    userMarker = L.marker(lastCoords, {
      icon: triangleIcon(heading || 0)
    }).addTo(map);
  } else {
    userMarker.setLatLng(lastCoords);
    userMarker.setIcon(triangleIcon(heading || 0));
  }

  if (followUser) {
    map.setView(lastCoords, map.getZoom() || 17);
  }
}

/* ================== –¢–†–ï–£–ì–û–õ–¨–ù–ò–ö ================== */
function triangleIcon(angle) {
  return L.divIcon({
    className: "",
    html: `<div style="
      width:0;height:0;
      border-left:10px solid transparent;
      border-right:10px solid transparent;
      border-bottom:20px solid blue;
      transform: rotate(${angle}deg);
    "></div>`
  });
}

/* ================== –î–ò–°–¢–ê–ù–¶–ò–Ø ================== */
function distanceMeters(lat1, lon1, lat2, lon2) {
  const R = 6371000;
  const toRad = x => x * Math.PI / 180;
  const dLat = toRad(lat2 - lat1);
  const dLon = toRad(lon2 - lon1);

  const a =
    Math.sin(dLat/2)**2 +
    Math.cos(toRad(lat1)) *
    Math.cos(toRad(lat2)) *
    Math.sin(dLon/2)**2;

  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}

/* ================== –ó–ê–ü–ò–°–¨ –¢–†–ï–ö–ê ================== */
function recordTrackPoint() {
  if (!lastCoords || lastSpeed < 0.5) return;

  const [lat, lon] = lastCoords;
  let dist = 0;

  if (lastTrackPoint) {
    dist = distanceMeters(
      lastTrackPoint.lat,
      lastTrackPoint.lon,
      lat,
      lon
    );
    if (dist < 5) return;
  }

  totalDistance += dist;

  const point = {
    lat, lon,
    time: new Date().toISOString(),
    speed: lastSpeed.toFixed(2),
    distance_from_prev_m: dist.toFixed(2),
    total_distance_m: totalDistance.toFixed(2)
  };

  trackPoints.push(point);
  lastTrackPoint = point;

  L.circleMarker([lat, lon], {
    radius: 4,
    color: "red",
    fillOpacity: 0.9
  }).addTo(trackLayer);
}

/* ================== CSV ================== */
function saveTrackCSV() {
  if (!trackPoints.length) {
    alert("–¢—Ä–µ–∫ –ø—É—Å—Ç");
    return;
  }

  let csv = "lat,lon,time,speed_m_s,distance_from_prev_m,total_distance_m\n";
  trackPoints.forEach(p => {
    csv += `${p.lat},${p.lon},${p.time},${p.speed},${p.distance_from_prev_m},${p.total_distance_m}\n`;
  });

  const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "track.csv";
  a.click();

  URL.revokeObjectURL(url);
}
</script>

</body>
</html>
