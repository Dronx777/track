<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<title>GPS —Ç—Ä–µ–∫–µ—Ä</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
html,body { margin:0; padding:0; height:100%; }
#map { height:100vh; width:100vw; }

/* –≤–µ—Ä—Ö–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ */
#topPanel {
  position:absolute;
  top:10px;
  left:50%;
  transform:translateX(-50%);
  z-index:1000;
  display:flex;
  gap:8px;
}
#topPanel button {
  padding:10px 14px;
  font-size:14px;
  background:#fff;
  border-radius:10px;
  border:1px solid #ccc;
  box-shadow:0 2px 6px rgba(0,0,0,0.25);
}

/* –∫–Ω–æ–ø–∫–∞ —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è */
#centerBtn {
  position:absolute;
  right:14px;
  top:55%;
  z-index:1000;
  width:48px;
  height:48px;
  border-radius:50%;
  background:#fff;
  border:1px solid #ccc;
  box-shadow:0 2px 6px rgba(0,0,0,0.3);
  display:none;
  align-items:center;
  justify-content:center;
  cursor:pointer;
}
#centerBtn::before {
  content:"";
  width:22px;
  height:22px;
  border:2px solid #000;
  border-radius:50%;
}
#centerBtn::after {
  content:"";
  width:4px;
  height:4px;
  background:#000;
  border-radius:50%;
  position:absolute;
}
</style>
</head>

<body>

<div id="topPanel">
  <button id="startBtn">–°—Ç–∞—Ä—Ç GPS</button>
  <button id="stopBtn">–°—Ç–æ–ø GPS</button>
  <button id="saveBtn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å CSV</button>
</div>

<div id="centerBtn"></div>
<div id="map"></div>

<script>
/* ===== –ö–∞—Ä—Ç–∞ ===== */
const map = L.map('map').setView([51.16, 71.47], 12);
L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

/* ===== –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ===== */
let watchId = null;
let followUser = false;
let userLatLng = null;
let lastLatLng = null;

let trackRecording = false;
let trackTimer = null;
let trackPoints = [];
let trackLayer = L.layerGroup().addTo(map);

/* ===== SVG —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫ ===== */
function createArrowIcon(angle = 0) {
  return L.divIcon({
    className: '',
    iconSize: [30, 30],
    iconAnchor: [15, 15],
    html: `
      <svg width="30" height="30" viewBox="0 0 100 100"
        style="transform: rotate(${angle}deg);">
        <polygon points="50,5 95,95 50,75 5,95"
          fill="white" stroke="black" stroke-width="6"/>
      </svg>
    `
  });
}

let userMarker = null;

/* ===== –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ ===== */
function updateUserPosition(pos) {
  const lat = pos.coords.latitude;
  const lon = pos.coords.longitude;
  userLatLng = [lat, lon];

  let angle = 0;
  if (lastLatLng) {
    const dx = lon - lastLatLng[1];
    const dy = lat - lastLatLng[0];
    angle = Math.atan2(dx, dy) * 180 / Math.PI;
  }
  lastLatLng = userLatLng;

  if (!userMarker) {
    userMarker = L.marker(userLatLng, { icon: createArrowIcon(angle) }).addTo(map);
    document.getElementById('centerBtn').style.display = 'flex';
  } else {
    userMarker.setLatLng(userLatLng);
    userMarker.setIcon(createArrowIcon(angle));
  }

  if (followUser) {
    map.setView(userLatLng, map.getZoom());
  }
}

/* ===== –ó–∞–ø–∏—Å—å —Ç—Ä–µ–∫–∞ ===== */
function recordTrackPoint() {
  if (!trackRecording || !userLatLng) return;

  const point = {
    lat: userLatLng[0],
    lon: userLatLng[1],
    time: new Date().toISOString()
  };
  trackPoints.push(point);

  L.circleMarker([point.lat, point.lon], {
    radius: 4,
    color: '#c00000',
    fillColor: '#ff0000',
    fillOpacity: 0.9
  }).addTo(trackLayer);
}

/* ===== –°—Ç–∞—Ä—Ç GPS ===== */
document.getElementById('startBtn').onclick = () => {
  if (!navigator.geolocation || watchId) return;

  trackRecording = true;
  followUser = true;
  trackPoints = [];
  trackLayer.clearLayers();
  lastLatLng = null;

  navigator.geolocation.getCurrentPosition(
    (pos) => {
      updateUserPosition(pos);
      map.setView(userLatLng, 16);

      watchId = navigator.geolocation.watchPosition(
        updateUserPosition,
        err => console.warn(err),
        { enableHighAccuracy: true, maximumAge: 1000 }
      );

      trackTimer = setInterval(recordTrackPoint, 3000);
    },
    () => alert('GPS –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω')
  );
};

/* ===== –°—Ç–æ–ø GPS ===== */
document.getElementById('stopBtn').onclick = () => {
  trackRecording = false;
  followUser = false;

  if (watchId) navigator.geolocation.clearWatch(watchId);
  watchId = null;

  if (trackTimer) clearInterval(trackTimer);
  trackTimer = null;
};

/* ===== –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ ===== */
document.getElementById('centerBtn').onclick = () => {
  if (!userLatLng) return;
  followUser = true;
  map.setView(userLatLng, 16);
};

/* ===== –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ CSV ===== */
document.getElementById('saveBtn').onclick = () => {
  if (!trackPoints.length) {
    alert('–¢—Ä–µ–∫ –ø—É—Å—Ç');
    return;
  }

  let csv = 'lat,lon,timestamp\n';
  trackPoints.forEach(p => {
    csv += `${p.lat},${p.lon},${p.time}\n`;
  });

  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);

  const a = document.createElement('a');
  const ts = new Date().toISOString().replace(/[:.]/g, '-');
  a.href = url;
  a.download = `track_${ts}.csv`;
  a.click();

  URL.revokeObjectURL(url);
};

/* ===== –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –∞–≤—Ç–æ—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è ===== */
map.on('dragstart', () => followUser = false);
map.on('zoomstart', () => followUser = false);
</script>

</body>
</html>
